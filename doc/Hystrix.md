## 分布式系统面临的问题

复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某个时候将不可避免的失败

## 服务雪崩

**扇出**

多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他微服务，
这就是所谓的"扇出"。

如果扇出的链路上某个微服务的调用响应时间过长或不可用，对微服务A的调用就会占用越来越多的系统资源，
进而引起系统崩溃，所谓的"雪崩效应"。

通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接受流量，然后这个有问题的模块还调用了其他
模块，这样就会发生级联故障，或者叫雪崩。

避免这种级联故障，就需要一种链路中断的方案：
服务降级、服务熔断。

## Hystrix简介

Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，
Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，已提高分布式系统的弹性。

## Hystrix功能

* 服务降级
程序运行异常
超时
服务熔断触发服务降级
线程池、信号量打满也会导致服务降级

* 服务熔断
类似保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示。

* 接近实时的监控

* 限流、隔离等
秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行。


## 降级容错解决的维度要求
* 1.超时导致服务器变慢（转圈）
超时不再等待

* 2.出错（宕机或程序运行出错）
出错要有兜底

* 3.解决
1）对方服务（8001）超时，调用者（80）不能一直卡死等待，必须有服务降级
2）对方服务（8001）宕机，调用者（80）不能一直卡死等待，必须有服务降级
3）对方服务（8001）OK，调用者（80）自己出故障或自我要求（自己的等待时间小于服务提供者），自己处理降级

## Hystrix 服务熔断
应对雪崩效应
当扇出链路的某个微服务出错不可用或响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。

在SpringCloud框架里，熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。
熔断机制的注解是@HystrixCommand

设计到断路器的三个重要参数：快照时间窗、请求总数阈值、错误百分比阈值

1.快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒

2.请求总数阈值：在快照时间内，必须满足请求总数阈值才有资格熔断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开

3.错误百分比阈值：当请求总数在快照时间窗内超过阈值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阈值情况下，这时候就会将断路器打开

```java
注解说明：
@HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback",commandProperties ={
        @HystrixProperty(name = "circuitBreaker.enabled",value = "true"), //是否开启断路器
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold",value = "10"), //请求次数
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds",value = "10000"), //时间窗口期
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage",value = "60"),//失败率达到多少后跳闸
})
```